---
title: "EPID674 Epidemiologic Data Analysis using R"
subtitle: "Exploring Data with R"
author: "Kelly Bakulski"
date: "Last compiled on `r format(Sys.Date(), '%B %d, %Y')`"
output:
   html_document: 
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) # This is how you set options for all chunks of code

sessionInfo() # check what packages are already loaded by default
```

## Chapter 2, Exploring Data with R

# Identify base packages and install new packages

```{r install_packages, eval=FALSE}

# Install packages. Do this only once.
# Note, we already installed packages to this workspace. If working on your personal computer, will need to run this code
install.packages("tidyverse")
install.packages("here")
install.packages("nhanesA")
install.packages("sjlabelled")
install.packages("gtsummary")
install.packages("flextable")

# To avoid installing every time: change set up in curly brackets to eval=FALSE
```

```{r load_packages}

# Load packages. Load relevant packages every time you start a new R session
library(tidyverse)
library(here)
library(nhanesA)
library(sjlabelled)
library(gtsummary)
library(flextable)
```

# Specify file directories

```{r directories}
here() # Orient yourself to the default file path format on your computer

#Expect to be when coding on RStudio Cloud
#"/cloud/project" 
```

# Data cleaning plan:
1) Download demographics, complete blood counts, and chemical data
2) Check datasets
3) Keep only the useful variables
4) Merge datasets
5) Fix data types and set reference levels
6) Create categorical variable
7) Create age groups
8) Save cleaned dataset


# Import datasets from 2017-2018 NHANES
* Datasets can be found at: **https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?BeginYear=2017**
* Data are saved in multiple datasets that we will need to combine
* NHANES variables have labels as well as variable names - those labels need to be removed for merging
```{r load}

# Download NHANES demographics data and remove the labels
demog <- nhanes("DEMO_J")
demog_unlab <- remove_label(demog)
# Check the column names (variable names)
colnames(demog_unlab)

# Check the Demographics Data website for information about these variables:
# https://wwwn.cdc.gov/nchs/nhanes/search/datapage.aspx?Component=Demographics&CycleBeginYear=2017
#   What does RIAGENDR mean?

# Download Complete Blood Cell Laboratory Data, remove the labels, check the column names
cbc <- nhanes("CBC_J")
cbc_unlab <- remove_label(cbc)
colnames(cbc_unlab)

# Download Iron Data, remove labels, check column names
fe <- nhanes("FETIB_J")
fe_unlab <- remove_label(fe)
colnames(fe_unlab)

# Download Arsenic Data, remove labels, check column names
as <- nhanes("UTAS_J")
as_unlab <- remove_label(as)
colnames(as_unlab)

# Download Cotinine Data, remove labels, check column names
cotinine <- nhanes("COT_J")
cotinine_unlab <- remove_label(cotinine)
colnames(cotinine_unlab)

# Download Cadmium and Lead Data, remove labels, check column names
cd_pb <- nhanes("PBCD_J")
cd_pb_unlab <- remove_label(cd_pb)
colnames(cd_pb_unlab)

# What variable is the same between the datasets?
```


# Explore the NHANES dataset

```{r dataset_explore}

# Explore the data set
str(demog_unlab) # Get detailed information about each variable and the object overall
dim(demog_unlab) # What are the dimensions?
colnames(demog_unlab) # Whate are the column names?
rownames(demog_unlab)[1:20] # What are the row names?


head(demog_unlab) # What do the first 6 rows look like?
demog_unlab[1:10, ] # What do the first 10 rows look like?
```


# Explore individual variables in the NHANES dataset

```{r explore_variables}
# Explore the variables
length(demog_unlab$RIDAGEYR)
demog_unlab$RIDAGEYR[1:10]

# Are there any duplicates?

# Look at the whole dataset
View(demog_unlab)
```

# Subset datasets to keep only useful variables

```{r select()}

# select() is a useful tidyverse function that keeps columns in a dataframe
# We only want to keep the necessary variables to avoid creating a huge dataset

############ Demographics dataset ############
dim(demog_unlab)
#9254   46
demog_subset <- demog_unlab %>%
  select(SEQN,     #participant identifier
         RIAGENDR, #sex
         RIDAGEYR, #age in years
         RIDRETH1, #race in number code
         INDFMPIR, #poverty-income ratio
         #these two are for later (survey weighting)
         SDMVSTRA, #Strata: based on census region, metropolitan area, or population demographics
         SDMVPSU   #Primary Sampling Unit: 30 per nhanes cycle - mostly single counties, selected from strata
         ) %>%
  rename(RIASEX = RIAGENDR) #rename RIAGENDR to be RIASEX because NHANES asked about sex, not gender
dim(demog_subset)
#9254    7 - number of rows does not change

############ Complete blood count dataset ############
dim(cbc_unlab)
#8366   22
cbc_subset <- cbc_unlab %>%
  select(SEQN,
         LBXRBCSI,
         LBXWBCSI,
         LBDLYMNO,
         LBDNENO)
dim(cbc_subset)
#8366    2

############ Iron dataset ############
dim(fe_unlab)
#6401    9
fe_subset <- fe_unlab %>%
  select(SEQN,
         LBXIRN)
dim(fe_subset)
#6401    2

############ Arsenic dataset ############
dim(as_unlab)
#2979    4
as_subset <- as_unlab %>%
  select(SEQN,
         URXUAS)
dim(as_subset)
#2979    2

############ Cotinine dataset ############
dim(cotinine_unlab)
#7936    5
cotinine_subset <- cotinine_unlab %>%
  select(SEQN,
         LBXCOT)
dim(cotinine_subset)
#7936    2

############ Cadmium/Lead dataset ############
dim(cd_pb_unlab)
#8366   16
cd_pb_subset <- cd_pb_unlab %>%
  select(SEQN,
         LBXBCD,
         LBXBPB)
dim(cd_pb_subset)
#8366    3
```


# Merge six datasets into one

```{r data_merge}

# Merge the demographics and complete blood count datasets
demog_cbc <- left_join(demog_subset, cbc_subset, by = "SEQN")
# Check the merge - How many participants and variables do you expect?
str(demog_cbc)

# Merge the previous dataset and iron dataset
demog_cbc_fe <- left_join(demog_cbc, fe_subset, by = "SEQN")
# Check the merge - How many participants and variables do you expect?
str(demog_cbc_fe)

# Merge the previous dataset and arsenic dataset
demog_cbc_fe_as <- left_join(demog_cbc_fe, as_subset, by = "SEQN")
# Check the merge - How many participants and variables do you expect?
str(demog_cbc_fe_as)

# Merge the previous dataset and cotinine dataset
demog_cbc_fe_as_cot <- left_join(demog_cbc_fe_as, cotinine_subset, by = "SEQN")
# Check the merge - How many participants and variables do you expect?
str(demog_cbc_fe_as_cot)

# Merge the previous dataset and cadmium/lead dataset
demog_cbc_chems <- left_join(demog_cbc_fe_as_cot, cd_pb_subset, by = "SEQN")
# Check the merge - How many participants and variables do you expect?
str(demog_cbc_chems)
```


# Convert variables from numeric to factors

```{r}

# Check the initial counts of race/ethnicity and sex
table(demog_cbc_chems$RIDRETH1)
table(demog_cbc_chems$RIASEX)

# Check the initial data type of the variables
str(demog_cbc_chems$RIDRETH1)
str(demog_cbc_chems$RIASEX)

# Update race/ethnicity and sex from numbers to characters
nhanes_factor <- demog_cbc_chems %>%
  mutate(race_eth = case_when(RIDRETH1 == 1 ~ "Mexican American",
                              RIDRETH1 == 2 ~ "Other Hispanic",
                              RIDRETH1 == 3 ~ "Non-Hispanic White",
                              RIDRETH1 == 4 ~ "Non-Hispanic Black",
                              RIDRETH1 == 5 ~ "Other Race"),
         sex = case_when(RIASEX == 1 ~ "Male",
                         RIASEX == 2 ~ "Female")) %>%
  mutate(sex = factor(sex),               #change the character variables into factor variables
         race_eth = factor(race_eth)) %>%
  mutate(sex = relevel(sex,               #set the reference levels
                       ref = "Male"),
         race_eth = relevel(race_eth,
                            ref = "Non-Hispanic White")) %>%
  relocate(race_eth, .after = RIDAGEYR) %>% #reorder the columns to keep the demographics together (mutate() automatically adds the new variable to the end of the dataset)
  relocate(sex, .after = race_eth)
  

# Check the counts of the new variables
table(nhanes_factor$race_eth)
table(nhanes_factor$sex)

# Do the counts still match?

# Check the data type of the new variables
str(nhanes_factor$race_eth)
str(nhanes_factor$sex)
```


# Create a new variable from continuous

```{r}

# Create a neutrophil:lymphocyte ratio variable (NLR)
nhanes_nlr <- nhanes_factor %>%
  mutate(nlr = LBDNENO / LBDLYMNO)


# View the new variable to look at the changes
nhanes_nlr %>%
  dplyr::select(SEQN,
                LBDNENO,
                LBDLYMNO,
                nlr) %>%
  View()
```


# Create a categorical variable from a continuous

```{r categorical}

# Create a categorical variable of iron status based on serum concentrations
nhanes_iron_categ <- nhanes_nlr %>%
  mutate(iron_status = case_when(LBXIRN < 60 ~ "Deficient",
                                 LBXIRN > 170 ~ "Excessive",
                                 LBXIRN >= 60 & LBXIRN <= 170 ~ "Normal")) %>%
  mutate(iron_status = relevel(factor(iron_status),
                               ref = "Deficient")) %>%
  relocate(iron_status, .after = LBXIRN)

# Check the structure of the dataset to see that iron_status is after LBXIRN and it is a factor with reference = "Deficient"
str(nhanes_iron_categ)
```


# Use the cut function to slice a numeric variable into groups
**Three different methods

```{r cut}

# Make groups of equal range
nhanes_age <- nhanes_iron_categ %>%
  mutate(cut_groups = cut_interval(RIDAGEYR, n = 5))
table(nhanes_age$cut_groups)


# Other options:

# Five groups with specified bin widths (16)
nhanes_dataset <- nhanes_iron_categ %>%
  mutate(cut_groups = cut_interval(RIDAGEYR, length = 16))
table(nhanes_age$cut_groups)

# Five groups with approximately equal numbers of participants (cut_number())
nhanes_dataset <- nhanes_iron_categ %>%
  mutate(cut_groups = cut_number(RIDAGEYR, n = 5))
table(nhanes_dataset$cut_groups)
```


# Save dataset for the future

```{r save_dataset}

# Save dataset as a csv file
write.csv(nhanes_age, file = here("nhanes_dataset.csv"),
          row.names=FALSE)
# Save dataset as an R object
save(nhanes_age, file = here("nhanes_dataset.rda"))

# Import dataset back into R from the csv or R object
nhanes_dataset <- read.csv(here(("nhanes_dataset.csv")))
load(here(("nhanes_dataset.rda")))
```


####################Split Point##########################


# Data description functions, numeric variables

```{r descriptives_numeric_variable}

# Base R method - quick, good for one variable at a time
summary(nhanes_dataset$RIDAGEYR)
# For missing values, include na.rm = TRUE:
sd(nhanes_dataset$LBXIRN, na.rm = TRUE)

# Tidyverse method - more code, but can be used to get summary statistics on multiple variables
nhanes_dataset %>%
  summarise(age_min = min(RIDAGEYR),
            age_25_quart = quantile(RIDAGEYR, probs = 0.25),
            age_mean = mean(RIDAGEYR),
            age_median = median(RIDAGEYR),
            age_75_quart = quantile(RIDAGEYR, probs = 0.75),
            age_iqr = IQR(RIDAGEYR),
            age_max = max(RIDAGEYR))

# Calculating statistics by groups - tidyverse
# Note: good practice to add ungroup() after using it to avoid the dataset staying grouped
nhanes_dataset %>%
  group_by(sex) %>%
  summarise(age_min = min(RIDAGEYR),
            age_25_quart = quantile(RIDAGEYR, probs = 0.25),
            age_mean = mean(RIDAGEYR),
            age_median = median(RIDAGEYR),
            age_75_quart = quantile(RIDAGEYR, probs = 0.75),
            age_iqr = IQR(RIDAGEYR),
            age_max = max(RIDAGEYR)) %>%
  ungroup()

# Do activity with this example
nhanes_dataset %>%
  group_by(sex) %>%
  summarise(age_mean = mean(RIDAGEYR),
            pir_mean = mean(INDFMPIR, na.rm = TRUE)) %>%
  ungroup()
```

# Calculate descriptive statistics on a categorical variable

```{r categorical_variable_descriptives}

# Base R method
table(nhanes_dataset$race_eth)
table(nhanes_dataset$race_eth, nhanes_dataset$sex)
```

# Create a publication-formatted table

```{r}
# Univariate table using gtsummary package
nhanes_dataset %>%
  select(-SEQN,
         -SDMVSTRA,
         -SDMVPSU) %>% #drop SEQN and survey variables so we don't get summary statistics for the identifiers or weights
  tbl_summary()


# Bivariate table by sex using gtsummary - will take about 5 seconds to run
bivar_nhanes <- nhanes_dataset %>%
  select(-SEQN,
         -SDMVSTRA,
         -SDMVPSU,
         -RIASEX,
         -RIDRETH1) %>%
  tbl_summary(by = sex, #stratify by sex
              label = list(RIDAGEYR    ~ "Age (years)", #update the variable names
                           race_eth    ~ "Race/Ethnicity",
                           INDFMPIR    ~ "Poverty-Income Ratio",
                           LBXRBCSI    ~ "Red Blood Cell Count (million cells/uL)",
                           LBXIRN      ~ "Iron (ug/dL)",
                           iron_status ~ "Iron Status",
                           URXUAS      ~ "Urinary Arsenic (ug/L)"),
              statistic = list(all_continuous() ~ "{mean} ({sd})", #use mean and standard deviation for continuous variables
                               all_categorical() ~ "{n} ({p}%)"),  #use count and percentage for categorical variables
              digits = list(all_categorical() ~ c(0, 1), #adds no decimal places to counts and one decimal to percentages
                            all_continuous() ~ 1), #adds one decimal place to mean and sd values
              missing_text = "Missing (n)"
              ) %>%
  add_p() %>% #compares male vs female, does not include overall in p-value calculation
  add_overall() %>% #adds column with non-stratified summary statistics
  modify_header(label ~ "**Variable**") %>% #the asterisks bold the label
  modify_spanning_header(c("stat_1", "stat_2") ~ "**Sex**") %>%
  bold_labels()

#View table
bivar_nhanes


# Save the table as a Word document - some formatting such as bold headers will be lost
bivar_nhanes %>%
  as_flex_table() %>%
  save_as_docx(path = here("summary_stats_table.docx")) #Export the table to Word using flextable package
```


# Do Exercise 2A


# Create a subset of the dataset

```{r subset}

# Practice subset: Keep only the female participants
nhanes_subset <- nhanes_dataset %>%
  filter(sex == "Female")

# Keep only the participants who are iron deficient and older than 60 years using filter()
nhanes_subset <- nhanes_dataset %>%
  filter(iron_status == "Deficient" & RIDAGEYR >= 60)

# How many participants have complete data?
nhanes_subset %>%
  na.omit() %>% #exclude any participants with missing data
  dim() #what are the dimensions after excluding missing data?
```



# Do Exercise 2B




# Ordering data

```{r}

#order by sex and then age
nhanes_ordered <- nhanes_dataset %>%
  arrange(sex, RIDAGEYR)
```

# Ready to do Exercise 3A



# Check function default settings for handling missing values

```{r check_default_missing}
### How do functions handle missing values?

#calculate a correlation between age and iron concentration
cor(nhanes_ordered$RIDAGEYR, nhanes_ordered$LBXIRN)
cor(nhanes_ordered$RIDAGEYR, nhanes_ordered$LBXIRN, use="complete.obs")

#calculate summary statistics on iron
summary(nhanes_ordered$LBXIRN)

#calculate the mean of iron
mean(nhanes_ordered$LBXIRN)
mean(nhanes_ordered$LBXIRN, na.rm = TRUE)
#note the na.omit - remove all rows that include NAs
mean(na.omit(nhanes_ordered$LBXIRN))
```


# Exclude some data 

```{r}

# Check the original counts 
table(nhanes_ordered$RIDAGEYR, useNA = "always")

# Exclude data for participants who are less than 1 years old
nhanes_age_1_85 <- nhanes_ordered %>%
  na_if(RIDAGEYR, 0) %>% #make all ages of 0 missing
  drop_na(RIDAGEYR) #if there is a missing in RIDAGEYR, drop that participant row (will drop participants who were age 0)

# Check new counts
table(nhanes_age_1_85$RIDAGEYR, useNA = "always")
```



# Try compiling results with a for loop

```{r for_loop}
# First prep the output dataset - set up blank columns
out <- data.frame(matrix(nrow = ncol(nhanes_ordered), ncol = 3))

#set the column names for the dataframe
colnames(out) <- c("variable", "mean", "sd")

#pull the column names from nhanes_ordered and set them as the values for the first column
out[, 1] <- colnames(nhanes_ordered)

# Then initiate the loop
for (i in 1:ncol(nhanes_ordered)) {
  out[i, 2] <- mean(as.numeric(nhanes_ordered[, i]), na.rm = TRUE)
  out[i, 3] <- sd(as.numeric(nhanes_ordered[, i]), na.rm = TRUE)
}
out

# Why do some variables have a mean of NA?
```


# Date and Time

# Input variable formats, convert to desired format

```{r date_format}
# create some dates to use in this exercise
bdays <- c("11/2/1959", "1/1/1970")
bdays
# convert to Julian dates
bdays.julian <- as.Date(bdays, format = "%m/%d/%Y")
bdays.julian

as.numeric(bdays.julian)

bdays.am <- format(bdays.julian, "%b %d, %Y")
bdays.am

# day of the week
format(bdays.julian, "%a-%d%b%y")
weekdays(bdays.julian)
```

# Calculate age as of today's date

```{r age_from_date}
date.today <- Sys.Date() # Sys.time or Sys.Date: Current time/Date
date.today

agecomp <- (date.today - bdays.julian) / 365.25
agecomp

agecomp2 <- trunc(as.numeric(agecomp))


# create data frame
bd <- data.frame(Birthday = bdays, Standard = bdays.julian, Julian = as.numeric(bdays.julian), Age = agecomp2)
bd
```

# Paste function

```{r paste}
# combine (paste) two or more variables that are parts of date
day1 <- c("12", "13", "14")
month1 <- c("07", "08", "12")
year1 <- c("1980", "2000", "2010")
paste(day1, month1, year1)

as.Date(paste(day1, month1, year1), "%d %m %Y")
```

# Ready to do Exercise 3B



# Remember to save your R script!

# To exit R

```{r exit, eval=F}
# q()
## if you close R, you will be asked to save your workspace image
```
